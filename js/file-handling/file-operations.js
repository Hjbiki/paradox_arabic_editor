// ===========================================
// FILE OPERATIONS - ุนูููุงุช ุงููููุงุช
// ===========================================

// Translation operations
function updateTranslation() {
    if (!currentEditingKey) {
        if (typeof showNotification === 'function') {
            showNotification('ูุฑุฌู ุงุฎุชูุงุฑ ุชุฑุฌูุฉ ุฃููุงู', 'warning');
        }
        return;
    }
    
    const key = currentEditingKey;
    const newValue = translationText ? translationText.value.trim() : '';
    
    // Store the clean text (without quotes and tags)
    if (translations) {
        translations[key] = newValue;
    }
    if (window.translations) {
        window.translations[key] = newValue;
    }
    
    if (filteredTranslations) {
        filteredTranslations[key] = newValue;
    }
    if (window.filteredTranslations) {
        window.filteredTranslations[key] = newValue;
    }
    
    // Update the list item
    if (translationList) {
        const items = translationList.querySelectorAll('.translation-item');
        if (items[currentIndex]) {
            const preview = newValue.length > (previewLength || 50) ? 
                newValue.substring(0, (previewLength || 50)) + '...' : newValue;
            const previewElement = items[currentIndex].querySelector('.translation-preview');
            if (previewElement) {
                previewElement.textContent = preview;
            }
        }
    }
    
    // Reset unsaved changes
    window.hasUnsavedChanges = false;
    hasUnsavedChanges = false;
    
    window.currentEditedValue = newValue;
    currentEditedValue = newValue;
    
    if (typeof updateSaveButton === 'function') {
        updateSaveButton();
    }
}

function undoChanges() {
    const key = translationKeys[currentIndex];
    
    if (!key) {
        console.log('โ ูุง ููุฌุฏ ููุชุงุญ ูุญุฏุฏ ููุฅุฑุฌุงุน');
        return;
    }
    
    // ุงุณุชุฑุฌุงุน ุงููุต ุงูุฃุตูู
    const originalValue = originalTranslations && originalTranslations[key] ? originalTranslations[key] : '';
    
    console.log(`๐ ุฅุฑุฌุงุน ุงูููุชุงุญ "${key}" ูููุต ุงูุฃุตูู:`);
    console.log(`๐ ุงููุต ุงูุญุงูู: "${translations[key] || ''}"`);
    console.log(`๐ ุงููุต ุงูุฃุตูู: "${originalValue}"`);
    
    // ุชุญุฏูุซ ุงููุต ูู ุฌููุน ุงููุงุฆูุงุช
    if (translations) {
        translations[key] = originalValue;
    }
    if (window.translations) {
        window.translations[key] = originalValue;
    }
    if (filteredTranslations) {
        filteredTranslations[key] = originalValue;
    }
    if (window.filteredTranslations) {
        window.filteredTranslations[key] = originalValue;
    }
    
    // ุฅุฒุงูุฉ ุงูููุชุงุญ ูู ูุงุฆูุฉ ุงูููุนุฏูุฉ
    if (modifiedKeys) {
        modifiedKeys.delete(key);
    }
    if (window.modifiedKeys) {
        window.modifiedKeys.delete(key);
    }
    
    // ุชุญุฏูุซ ุงููุชุบูุฑุงุช ุงููุคูุชุฉ
    window.currentEditedValue = originalValue;
    currentEditedValue = originalValue;
    window.hasUnsavedChanges = false;
    hasUnsavedChanges = false;
    
    console.log(`โ ุชู ุฅุฑุฌุงุน ุงูููุชุงุญ "${key}" ูููุต ุงูุฃุตูู`);
    
    // ุชุญุฏูุซ ุนูุตุฑ ุงููุต ูู ุงููุงุฌูุฉ
    if (translationText) {
        translationText.value = originalValue;
        
        // ุชุญุฏูุซ ุนูุตุฑ ุงููุงุฆูุฉ
        if (translationList) {
            const items = translationList.querySelectorAll('.translation-item');
            if (items[currentIndex]) {
                items[currentIndex].classList.remove('modified');
                
                // ุชุญุฏูุซ ุงููุนุงููุฉ ูู ุงููุงุฆูุฉ
                const preview = originalValue.length > (previewLength || 50) ? 
                    originalValue.substring(0, (previewLength || 50)) + '...' : originalValue;
                const previewElement = items[currentIndex].querySelector('.translation-preview');
                if (previewElement) {
                    previewElement.textContent = preview;
                }
            }
        }
        
        // ุชุญุฏูุซ blocks mode ุฅุฐุง ูุงู ููุนูุงู
        const container = translationText.parentNode;
        if (container) {
            const blocksEditor = container.querySelector('.blocks-editor');
            if (blocksEditor && blocksEditor.style.display !== 'none') {
                setTimeout(() => {
                    if (typeof refreshBlocks === 'function') {
                        refreshBlocks(blocksEditor, translationText);
                    }
                    console.log('โ ุชู ุชุญุฏูุซ ุงูุจูููุงุช ุจุนุฏ ุฅุนุงุฏุฉ ุงูุชุนููู');
                }, 50);
            }
        }
    }
    
    // ุชุญุฏูุซ ุงููุต ุงููุฑุฌุนู ุฅุฐุง ูุงู ูุชููุฑุงู
    const englishText = englishTranslations ? englishTranslations[key] : '';
    if (englishText && typeof updateOriginalTextDisplay === 'function') {
        updateOriginalTextDisplay(englishText, originalValue);
    }
    
    if (typeof updateSaveButton === 'function') {
        updateSaveButton();
    }
    if (typeof updateStats === 'function') {
        updateStats();
    }
    
    if (typeof showNotification === 'function') {
        showNotification('ุชู ุฅุนุงุฏุฉ ุชุนููู ุงูุชุฑุฌูุฉ ุฅูู ุงููููุฉ ุงูุฃุตููุฉ', 'success');
    }
    console.log('โ ุชู ุฅุนุงุฏุฉ ุชุนููู ุงูุชุฑุฌูุฉ ุจูุฌุงุญ');
}

// Save operations
function saveAllChanges() {
    if (!currentFile) {
        if (typeof showNotification === 'function') {
            showNotification('ูุฑุฌู ูุชุญ ููู ุฃููุงู', 'warning');
        }
        return;
    }
    
    // Save all changes to the current translation
    if (hasUnsavedChanges && translationText) {
        const key = translationKeys ? translationKeys[currentIndex] : '';
        const newValue = translationText.value.trim();
        
        // Store the clean text (without quotes and tags)
        if (translations && key) {
            translations[key] = newValue;
        }
        if (window.translations && key) {
            window.translations[key] = newValue;
        }
        
        if (filteredTranslations && key) {
            filteredTranslations[key] = newValue;
        }
        if (window.filteredTranslations && key) {
            window.filteredTranslations[key] = newValue;
        }
        
        // Mark as modified
        if (modifiedKeys && key) {
            modifiedKeys.add(key);
        }
        if (window.modifiedKeys && key) {
            window.modifiedKeys.add(key);
        }
        
        // Update the list item
        if (translationList) {
            const items = translationList.querySelectorAll('.translation-item');
            if (items[currentIndex]) {
                // ุชูุธูู ุงููุต ูููุนุงููุฉ
                let cleanNewValue = newValue;
                if (typeof cleanText === 'function') {
                    cleanNewValue = cleanText(newValue);
                }
                
                const preview = cleanNewValue.length > (previewLength || 50) ? 
                    cleanNewValue.substring(0, (previewLength || 50)) + '...' : cleanNewValue;
                const previewElement = items[currentIndex].querySelector('.translation-preview');
                if (previewElement) {
                    previewElement.textContent = preview;
                }
                items[currentIndex].classList.add('modified');
            }
        }
        
        if (typeof updateStats === 'function') {
            updateStats();
        }
        
        // Reset unsaved changes for current translation
        window.hasUnsavedChanges = false;
        hasUnsavedChanges = false;
        window.currentEditedValue = newValue;
        currentEditedValue = newValue;
    }
    
    saveToFile(currentFile.name);
    
    // Clear all modifications after saving
    if (modifiedKeys && modifiedKeys.clear) {
        modifiedKeys.clear();
    }
    if (window.modifiedKeys && window.modifiedKeys.clear) {
        window.modifiedKeys.clear();
    }
    
    window.hasUnsavedChanges = false;
    hasUnsavedChanges = false;
    // Note: currentEditingKey is kept as user might continue editing the same translation
    
    // Remove modified class from all items in the DOM
    if (translationList) {
        const allItems = translationList.querySelectorAll('.translation-item.modified');
        allItems.forEach(item => {
            item.classList.remove('modified');
        });
    }
    
    if (typeof updateSaveButton === 'function') {
        updateSaveButton();
    }
    if (typeof updateStats === 'function') {
        updateStats();
    }
    
    if (typeof showNotification === 'function') {
        showNotification('ุชู ุญูุธ ุงูููู ุจูุฌุงุญ!', 'success');
    }
}

function saveFile() {
    if (!currentFile) {
        if (typeof showNotification === 'function') {
            showNotification('ูุฑุฌู ุชุญููู ููู ุฃููุงู ูุจู ุงูุญูุธ', 'warning');
        }
        return;
    }
    
    // ุชุญูู ูู ุฃู ูุฐุง ุฃูู ุญูุธ ูููุณุชุฎุฏู
    const hasSeenSaveExplanation = localStorage.getItem('paradox_editor_save_explained');
    
    if (typeof showNotification === 'function') {
        if (!hasSeenSaveExplanation) {
            // ุฑุณุงูุฉ ุชูุถูุญูุฉ ูุฃูู ูุฑุฉ
            showNotification(
                '๐พ ูุนูููุงุช ูููุฉ ุนู ุงูุญูุธ:\n\n' +
                '๐ ุงูุชุฎุฒูู ุงูุชููุงุฆู: ูุญูุธ ุนููู ูู ุงููุชุตูุญ ููุท\n' +
                '๐ ุญูุธ ุงูููู: ููุฒู ุงูููู ุงููุญุฏุซ ุนูู ุฌูุงุฒู\n\n' +
                'โ ุงูุขู ุณูุชู ุชูุฒูู ุงูููู ุงููุญุฏุซ...',
                'info'
            );
            localStorage.setItem('paradox_editor_save_explained', 'true');
            
            // ุงูุชุธุงุฑ ูููู ูุจู ุงูุญูุธ ูููุฑุฃ ุงููุณุชุฎุฏู ุงูุฑุณุงูุฉ
            setTimeout(() => {
                saveToFile(currentFile);
            }, 3000);
        } else {
            // ุญูุธ ุนุงุฏู
            showNotification('ุฌุงุฑู ุญูุธ ุงูููู...', 'info');
            saveToFile(currentFile);
        }
    } else {
        saveToFile(currentFile);
    }
}

function saveAsFile() {
    const filename = prompt('ุฃุฏุฎู ุงุณู ุงูููู:', 'translation.yml');
    if (filename) {
        saveToFile(filename);
    }
}

function saveToFile(filename) {
    try {
        // Create YAML content
        let yamlContent = 'l_english:\n';
        
        const translationsToSave = translations || {};
        Object.entries(translationsToSave).forEach(([key, value]) => {
            // Add quotes around the value for proper YAML format
            const escapedValue = value.replace(/"/g, '\\"');
            yamlContent += `  ${key}: "${escapedValue}"\n`;
        });
        
        // Create and download file
        const blob = new Blob([yamlContent], { type: 'text/yaml;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename.endsWith('.yml') ? filename : filename + '.yml';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // ุฅุนุงุฏุฉ ุชุนููู ุญุงูุฉ ุงูุชุนุฏููุงุช
        if (typeof modifiedKeys !== 'undefined') {
            modifiedKeys.clear();
        }
        hasUnsavedChanges = false;
        
        if (typeof updateStatus === 'function') {
            updateStatus(filename);
        }
        
        if (typeof updateSaveButton === 'function') {
            updateSaveButton();
        }
        
        // ุฑุณุงูุฉ ูุฌุงุญ ูุงุถุญุฉ
        if (typeof showNotification === 'function') {
            const downloadName = filename.endsWith('.yml') ? filename : filename + '.yml';
            showNotification(
                `โ ุชู ุญูุธ ุงูููู ุจูุฌุงุญ!\n\n` +
                `๐ ุงุณู ุงูููู: ${downloadName}\n` +
                `๐ ุชู ุชูุฒููู ูู ูุฌูุฏ Downloads\n` +
                `๐พ ุฌููุน ุงูุชุนุฏููุงุช ูุญููุธุฉ ูู ุงูููู`,
                'success'
            );
        }
        
        console.log(`โ ุชู ุญูุธ ุงูููู ุจูุฌุงุญ: ${filename}`);
        
    } catch (error) {
        if (typeof showNotification === 'function') {
            showNotification(`ุฎุทุฃ ูู ุญูุธ ุงูููู: ${error.message}`, 'error');
        }
    }
}

// Make functions available globally
if (typeof window !== 'undefined') {
    window.updateTranslation = updateTranslation;
    window.undoChanges = undoChanges;
    window.saveAllChanges = saveAllChanges;
    window.saveFile = saveFile;
    window.saveAsFile = saveAsFile;
    window.saveToFile = saveToFile;
} 